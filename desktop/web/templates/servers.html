<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chowkidar - Multi-Server Monitor</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/servers.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="servers-container">
        <main class="servers-main">
            <header class="servers-topbar">
                <div class="topbar-left">
                    <h1 class="logo">⚙️ Chowkidar</h1>
                    <div class="servers-stats" aria-label="Server status summary">
                        <div class="stat-card">
                            <span class="stat-label">Total</span>
                            <span class="stat-value" id="serversTotal">0</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Online</span>
                            <span class="stat-value online" id="serversOnline">0</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label">Offline</span>
                            <span class="stat-value offline" id="serversOffline">0</span>
                        </div>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="grouping-wrapper">
                        <label for="groupBySelect">Group by</label>
                        <select id="groupBySelect">
                            <option value="none">None</option>
                            <option value="status">Status</option>
                            <option value="group" selected>Group</option>
                            <option value="tags">Tags</option>
                        </select>
                    </div>
                    <div class="search-wrapper">
                        <input type="search" id="serverSearchInput" placeholder="Search by name or IP">
                    </div>
                    <button type="button" class="btn-add-server" id="btnAddServer" title="Add new server"
                        onclick="document.getElementById('addServerModal')?.classList.add('active')">
                        <span class="icon">+</span>
                    </button>
                </div>
            </header>

            <section class="servers-grid" id="serversList">
                <!-- Server cards will be added here dynamically -->
            </section>
        </main>
    </div>

    <!-- Add Server Modal -->
    <div class="modal" id="addServerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Server</h2>
                <button type="button" class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="addServerForm" class="modal-form"
                onsubmit="return window.handleAddServerSubmit && window.handleAddServerSubmit(event)">
                <div class="form-group">
                    <label for="serverNameInput">Server Name</label>
                    <input type="text" id="serverNameInput" placeholder="e.g., Production Server" required>
                </div>
                <div class="form-group">
                    <label for="serverHostInput">Server URL</label>
                    <input type="url" id="serverHostInput" placeholder="e.g., http://192.168.1.100:8080" required>
                </div>
                <div class="form-group">
                    <label for="serverTokenInput">Auth Token (optional)</label>
                    <input type="text" id="serverTokenInput" placeholder="Leave empty to auto-generate">
                </div>
                <div class="form-group">
                    <label for="serverGroupInput">Group (optional)</label>
                    <input type="text" id="serverGroupInput" placeholder="e.g., Production">
                </div>
                <div class="form-group">
                    <label for="serverTagsInput">Tags (comma separated)</label>
                    <input type="text" id="serverTagsInput" placeholder="e.g., web, api">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Server</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Server Modal -->
    <div class="modal" id="editServerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Server</h2>
                <button type="button" class="modal-close" id="closeEditModal">&times;</button>
            </div>
            <form id="editServerForm" class="modal-form">
                <div class="form-group">
                    <label for="editServerNameInput">Server Name</label>
                    <input type="text" id="editServerNameInput" required>
                </div>
                <div class="form-group">
                    <label for="editServerHostInput">Server URL</label>
                    <input type="url" id="editServerHostInput" required>
                </div>
                <div class="form-group">
                    <label for="editServerTokenInput">Auth Token (optional)</label>
                    <input type="text" id="editServerTokenInput" placeholder="Leave empty to auto-generate">
                </div>
                <div class="form-group">
                    <label for="editServerGroupInput">Group (optional)</label>
                    <input type="text" id="editServerGroupInput" placeholder="e.g., Production">
                </div>
                <div class="form-group">
                    <label for="editServerTagsInput">Tags (comma separated)</label>
                    <input type="text" id="editServerTagsInput" placeholder="e.g., web, api">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" id="deleteServerBtn">Delete</button>
                    <button type="button" class="btn btn-secondary" id="cancelEditModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/base-url.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/websocket-client.js"></script>
    <script src="/static/js/servers.js"></script>
    <script>
        (function () {
            const addButton = document.getElementById("btnAddServer");
            const addModal = document.getElementById("addServerModal");
            const addForm = document.getElementById("addServerForm");
            const serversList = document.getElementById("serversList");
            if (!addButton || !addModal) return;

            addButton.addEventListener("click",() => {
                if (window.serverManager && window.serverManager.showAddModal) {
                    window.serverManager.showAddModal();
                    return;
                }
                addModal.classList.add("active");
            });

            function renderFallback(servers) {
                if (!serversList) return;
                serversList.innerHTML = "";
                servers.forEach((server) => {
                    const item = document.createElement("div");
                    item.className = "server-item";
                    item.innerHTML = `
                        <div class="server-item-content">
                            <p class="server-item-name">${server.name}</p>
                            <p class="server-item-status offline">offline</p>
                        </div>
                    `;
                    serversList.appendChild(item);
                });
            }

            if (addForm) {
                addForm.addEventListener("submit",(event) => {
                    if (window.serverManager && window.serverManager.addServer) {
                        return;
                    }
                    event.preventDefault();
                    const name = document.getElementById("serverNameInput").value;
                    const url = document.getElementById("serverHostInput").value;
                    if (!name || !url) {
                        alert("Please fill in all required fields");
                        return;
                    }
                    window.__fallbackServers = window.__fallbackServers || [];
                    window.__fallbackServers.push({ name,url });
                    renderFallback(window.__fallbackServers);
                    addModal.classList.remove("active");
                    addForm.reset();
                });
            }
        })();
    </script>
</body>

</html>